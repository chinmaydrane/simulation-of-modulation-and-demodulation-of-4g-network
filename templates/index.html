<!-- filename: templates/index2.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>4G PHY Layer Simulator (Web)</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .controls { display: flex; gap: 20px; margin-bottom: 20px; align-items: flex-end; }
        .block-diagram { border: 2px solid #3498db; padding: 15px; border-radius: 5px; margin-bottom: 20px; overflow-x: auto; background-color: #ecf0f1; }
        .block-flow { display: flex; align-items: center; justify-content: space-between; }
        .block { background: #3498db; color: white; padding: 10px 15px; border-radius: 4px; font-weight: bold; white-space: nowrap; text-align: center; }
        .arrow { font-size: 24px; color: #3498db; margin: 0 5px; }
        .result-box { background: #e8f5e9; padding: 10px; border: 1px solid #c8e6c9; border-radius: 4px; font-weight: bold; margin-top: 10px; }
        .plot-container { display: flex; flex-wrap: wrap; justify-content: space-around; gap: 20px; margin-top: 20px; }
        .plot-box { flex: 1; min-width: 45%; border: 1px solid #ccc; border-radius: 5px; padding: 10px; background: #fff; }
        button { padding: 10px 15px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        #startSimBtn { background-color: #2ecc71; color: white; }
        #berSweepBtn { background-color: #e67e22; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ“¡ 4G (LTE) PHY Layer Simulator</h2>
    
    <h3>Simulation Flow Diagram (Blocks and Arrows)</h3>
    <div class="block-diagram">
        <div class="block-flow">
            <div class="block">Random Bits</div>
            <div class="arrow">â†’</div>
            <div class="block">QAM Mod</div>
            <div class="arrow">â†’</div>
            <div class="block">OFDM Tx (IFFT/CP)</div>
            <div class="arrow">â†’</div>
            <div class="block" style="background: #e74c3c;">AWGN Channel</div>
            <div class="arrow">â†’</div>
            <div class="block">OFDM Rx (CP/FFT)</div>
            <div class="arrow">â†’</div>
            <div class="block">QAM Demod</div>
            <div class="arrow">â†’</div>
            <div class="block">BER Calculation</div>
        </div>
    </div>
    
    <h3>Simulation Parameters</h3>
    <div class="controls">
        <label>QAM Order (M): 
            <select id="qam_order">
                <option value="4">4-QAM (QPSK)</option>
                <option value="16" selected>16-QAM</option>
                <option value="64">64-QAM</option>
            </select>
        </label>
        <label>Es/N0 (SNR) [dB]: <input type="number" id="snr_db" value="10" min="0" max="30" step="1" style="width: 50px;"></label>
        <label>Number of Bits: <input type="number" id="num_bits" value="10000" min="100" step="1000" style="width: 80px;"></label>
        
        <button id="startSimBtn" onclick="startSimulation()">â–¶ Start Simulation (Plots & BER)</button>
        <button id="berSweepBtn" onclick="startBerSweep()">ðŸ“ˆ Plot BER vs SNR Curve (Sweep)</button>
    </div>
    
    <div class="result-box">
        Resulting BER: <span id="ber_output">N/A (Run Simulation first)</span>
    </div>
    
    <div class="plot-container">
        <div class="plot-box">
            <h4 style="text-align: center;">Live Constellation Diagram</h4>
            <div id="constellation_plot"></div>
        </div>
        <div class="plot-box">
            <h4 style="text-align: center;">Time Domain Signal (TX vs RX)</h4>
            <div id="time_signal_plot"></div>
        </div>

        <!-- NEW: Carrier Mixing & Separation Plot Box -->
        <div class="plot-box">
            <h4 style="text-align: center;">Carrier Mixing & Separation</h4>
            <div id="carrier_mixing_plot"></div>
        </div>

        <div class="plot-box" style="flex-basis: 100%;">
            <h4 style="text-align: center;">BER vs SNR Graph (Full Sweep)</h4>
            <div id="ber_snr_plot"></div>
        </div>
    </div>
    
</div>

<script>
    // --- Helper Functions ---
    function getParams() {
        return {
            qam_order: document.getElementById('qam_order').value,
            snr_db: document.getElementById('snr_db').value,
            num_bits: document.getElementById('num_bits').value
        };
    }

    // --- Single Simulation Run (Constellation, Time Signal & BER) ---
    async function startSimulation() {
        document.getElementById('ber_output').textContent = 'Running... Please wait.';
        
        const params = getParams();
        
        try {
            const response = await fetch('/run_sim', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                document.getElementById('ber_output').textContent = data.ber;
                Plotly.react('constellation_plot', JSON.parse(data.constellation_plot));
                Plotly.react('time_signal_plot', JSON.parse(data.time_signal_plot));

                // NEW: update carrier mixing plot if present
                if (data.carrier_mixing_plot) {
                    Plotly.react('carrier_mixing_plot', JSON.parse(data.carrier_mixing_plot));
                }
            } else {
                document.getElementById('ber_output').textContent = `ERROR: ${data.message || 'Unknown error.'}`;
            }
        } catch (error) {
            console.error('Fetch error:', error);
            document.getElementById('ber_output').textContent = 'A network or server error occurred.';
        }
    }

    // --- BER Sweep Run (Optimization/Error Handling) ---
    async function startBerSweep() {
        // Clear previous plot and show status message
        Plotly.purge('ber_snr_plot');
        document.getElementById('ber_snr_plot').innerHTML = '<p style="text-align:center;">Calculating BER sweep... This may take a few moments.</p>';
        
        const params = getParams();
        
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); 
            
            const response = await fetch('/run_ber_sweep', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params),
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);

            if (!response.ok) {
                throw new Error(`Server returned status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.status === 'success') {
                document.getElementById('ber_snr_plot').innerHTML = '';
                Plotly.react('ber_snr_plot', JSON.parse(data.ber_plot));
            } else {
                document.getElementById('ber_snr_plot').innerHTML = `<h4>ERROR during sweep:</h4> <p>${data.message || 'Unknown backend error.'}</p>`;
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                document.getElementById('ber_snr_plot').innerHTML = '<h4>ERROR:</h4> <p>Simulation timed out after 30 seconds. Try reducing the Number of Bits.</p>';
            } else {
                document.getElementById('ber_snr_plot').innerHTML = `<h4>NETWORK ERROR:</h4> <p>${error.message}</p>`;
            }
            console.error('Fetch error:', error);
        }
    }

    // Initialize the page with placeholder plots
    document.addEventListener('DOMContentLoaded', () => {
        Plotly.newPlot('constellation_plot', [{x:[], y:[], mode:'markers'}], {title: 'Received Constellation'});
        Plotly.newPlot('time_signal_plot', [{x:[], y:[], mode:'lines'}], {title: 'Time Domain Signal'});
        Plotly.newPlot('carrier_mixing_plot', [{x:[], y:[], mode:'lines'}], {title: 'Carrier Mixing & Separation'});
        Plotly.newPlot('ber_snr_plot', [{x:[], y:[], mode:'lines+markers'}], {title: 'BER vs SNR'});
    });
</script>

</body>
</html>
